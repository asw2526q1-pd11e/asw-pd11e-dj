<style>
    #comments-section {
      margin-top: 60px;
      border-top: 2px solid #eee;
      padding-top: 30px;
    }

    .comment {
      background-color: #fafafa;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .comment strong {
      color: #d63384;
    }

    .comment .meta {
      font-size: 0.9em;
      color: #777;
      margin-bottom: 5px;
    }

    .comment-votes {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .comment-vote-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      padding: 0;
      transition: transform 0.2s;
    }

    .comment-vote-btn:hover {
      transform: scale(1.2);
    }

    .comment-vote-btn.up {
      color: #28a745;
    }

    .comment-vote-btn.down {
      color: #dc3545;
    }

    .comment-vote-count {
      font-weight: bold;
      font-size: 0.95em;
      color: #555;
      min-width: 30px;
      text-align: center;
    }
</style>

<div id="comments-section">
    <h3 class="text-center mb-4">ðŸ’¬ Comentarios</h3>
    <div id="comments-container" class="text-start"></div>
</div>

<script>
    // Cargar los comentarios del post actual
    fetch(`/blog/posts/{{ post_id }}/comments/`)
      .then(res => res.json())
      .then(comments => {
        const container = document.getElementById("comments-container");
        if (comments.length === 0) {
          container.innerHTML = "<p class='text-muted text-center'>AÃºn no hay comentarios. SÃ© el primero en opinar âœ¨</p>";
        } else {
          renderComments(comments, container, 0);
        }
      })
      .catch(err => {
        console.error("Error cargando comentarios:", err);
        document.getElementById("comments-container").innerHTML =
          "<p class='text-danger text-center'>No se pudieron cargar los comentarios ðŸ˜ž</p>";
      });

    // FunciÃ³n recursiva para renderizar los hilos de comentarios
    function renderComments(comments, container, level) {
      comments.forEach(comment => {
        const div = document.createElement("div");
        div.classList.add("comment");
        div.style.marginLeft = `${level * 30}px`;

        div.innerHTML = `
          <div class="meta">
            <strong>${comment.author}</strong> â€” <em>${new Date(comment.published_date).toLocaleString()}</em>
          </div>
          <p>${comment.content}</p>
          ${comment.image ? `<img src="${comment.image}" alt="imagen del comentario" style="max-width:150px;border-radius:8px;margin-top:5px;">` : ""}

          <div class="comment-votes">
            <button class="comment-vote-btn up" onclick="voteComment(${comment.id}, 'up')" title="Me gusta">â–²</button>
            <span class="comment-vote-count" id="comment-votes-${comment.id}">${comment.votes}</span>
            <button class="comment-vote-btn down" onclick="voteComment(${comment.id}, 'down')" title="No me gusta">â–¼</button>
          </div>
        `;

        container.appendChild(div);

        // Renderizar respuestas recursivamente
        if (comment.replies && comment.replies.length > 0) {
          renderComments(comment.replies, container, level + 1);
        }
      });
    }

    // FunciÃ³n para votar comentarios (endpoints pendientes de implementar)
    function voteComment(commentId, voteType) {
      const endpoint = voteType === 'up'
        ? `/blog/comments/${commentId}/upvote/`
        : `/blog/comments/${commentId}/downvote/`;

      fetch(endpoint, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.votes !== undefined) {
          document.getElementById(`comment-votes-${commentId}`).textContent = data.votes;
        }
      })
      .catch(err => {
        console.error('Error al votar:', err);
        alert('No se pudo registrar el voto. El endpoint aÃºn no estÃ¡ implementado.');
      });
    }

    // FunciÃ³n auxiliar para obtener el token CSRF
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
</script>