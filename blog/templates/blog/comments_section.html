<style>
  #comments-section {
    margin-top: 60px;
    border-top: 2px solid #eee;
    padding-top: 30px;
  }

  .comment {
    background-color: #fafafa;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  .comment strong {
    color: #d63384;
  }

  .comment .meta {
    font-size: 0.9em;
    color: #777;
    margin-bottom: 5px;
  }

  .comment-votes {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }

  .comment-vote-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    padding: 0;
    transition: transform 0.2s;
  }

  .comment-vote-btn:hover {
    transform: scale(1.2);
  }

  .comment-vote-btn.up.active {
    color: #28a745;
  }

  .comment-vote-btn.down.active {
    color: #dc3545;
  }

  .comment-vote-btn.up,
  .comment-vote-btn.down {
    color: #ccc;
  }

  .comment-vote-count {
    font-weight: bold;
    font-size: 0.95em;
    color: #555;
    min-width: 30px;
    text-align: center;
  }

  .reply-btn {
    background: none;
    border: none;
    color: #007bff;
    cursor: pointer;
    font-size: 0.9em;
    padding: 0;
    margin-left: 15px;
    text-decoration: underline;
  }

  .reply-btn:hover {
    color: #0056b3;
  }

  .comment-form {
    background-color: #f8f9fa;
    border-radius: 6px;
    padding: 10px 12px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    width: 100%;
    max-width: 1300px;
  }

  .comment-form textarea {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.85em;
    min-height: 60px;
    resize: vertical;
  }

  .comment-form button {
    background-color: #d63384;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    transition: background-color 0.3s;
  }

  .comment-form button:hover {
    background-color: #b02a6a;
  }

  .reply-form {
    margin-top: 10px;
    margin-left: 30px;
    background-color: #fff;
    border-left: 2px solid #d63384;
    padding: 8px 10px;
    border-radius: 4px;
  }

  .cancel-btn {
    background-color: #6c757d;
    margin-left: 10px;
  }

  .cancel-btn:hover {
    background-color: #545b62;
  }
</style>

<div id="comments-section">
  <h3 class="text-center mb-4">ðŸ’¬ Comentarios</h3>

  <div class="comment-form">
    <form id="main-comment-form" enctype="multipart/form-data">
      {% csrf_token %}
      <textarea id="main-content" name="content" placeholder="Escribe tu comentario..." required></textarea>
      <input type="file" id="main-image" name="image" accept="image/*">
      <button type="submit">Publicar comentario</button>
    </form>
  </div>

  <div id="comments-container"></div>
</div>

<script>
  const postId = {{ post.id }};

  function loadComments() {
    fetch(`/blog/posts/${postId}/comments/`)
      .then(res => res.json())
      .then(comments => {
        const container = document.getElementById("comments-container");
        container.innerHTML = "";
        if (comments.length === 0) {
          container.innerHTML = "<p class='text-muted text-center'>AÃºn no hay comentarios. SÃ© el primero en opinar âœ¨</p>";
        } else {
          renderComments(comments, container, 0);
        }
      });
  }

  function renderComments(comments, container, level) {
    comments.forEach(comment => {
      const div = document.createElement("div");
      div.classList.add("comment");
      div.style.marginLeft = `${level * 30}px`;
      div.id = `comment-${comment.id}`;

      // Determinar color de botones segÃºn voto del usuario
      const upClass = comment.user_vote === 1 ? "active" : "";
      const downClass = comment.user_vote === -1 ? "active" : "";

      div.innerHTML = `
        <div class="meta">
            <strong>
                <a href="/accounts/profile/${comment.author}" style="color:#d63384; text-decoration:none;">
                ${escapeHtml(comment.author)}
                </a>
            </strong>
            â€” <em>${new Date(comment.published_date).toLocaleString()}</em>
        </div>

        <p>${escapeHtml(comment.content)}</p>
        ${comment.image ? `<img src="${comment.image}" style="max-width:150px;border-radius:8px;margin-top:5px;">` : ""}
        <div class="comment-votes">
          <button class="comment-vote-btn up ${upClass}" onclick="voteComment(${comment.id}, 'up')">â–²</button>
          <span class="comment-vote-count" id="comment-votes-${comment.id}">${comment.votes}</span>
          <button class="comment-vote-btn down ${downClass}" onclick="voteComment(${comment.id}, 'down')">â–¼</button>
          <button class="reply-btn" onclick="showReplyForm(${comment.id})">Responder</button>
        </div>
      `;

      container.appendChild(div);

      if (comment.replies && comment.replies.length > 0) {
        renderComments(comment.replies, container, level + 1);
      }
    });
  }

  function showReplyForm(commentId) {
    document.querySelectorAll(".reply-form").forEach(f => f.remove());
    const commentDiv = document.getElementById(`comment-${commentId}`);
    const replyFormDiv = document.createElement("div");
    replyFormDiv.classList.add("reply-form");
    replyFormDiv.innerHTML = `
      <form class="reply-comment-form" data-parent-id="${commentId}" enctype="multipart/form-data">
        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
        <textarea name="content" placeholder="Tu respuesta..." required></textarea>
        <input type="file" name="image" accept="image/*">
        <button type="submit">Responder</button>
        <button type="button" class="cancel-btn" onclick="this.closest('.reply-form').remove()">Cancelar</button>
      </form>
    `;
    commentDiv.appendChild(replyFormDiv);
    replyFormDiv.querySelector("form").addEventListener("submit", handleCommentSubmit);
  }

  function handleCommentSubmit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const parentId = e.target.dataset.parentId || null;
    if (parentId) formData.append("parent_id", parentId);

    fetch(`/blog/posts/${postId}/comments/create/`, {
      method: "POST",
      body: formData,
      headers: { "X-CSRFToken": getCookie("csrftoken") }
    }).then(res => {
      if (res.ok) {
        e.target.reset();
        e.target.closest(".reply-form")?.remove();
        loadComments();
      } else {
        alert("Error al publicar el comentario.");
      }
    });
  }

  document.getElementById("main-comment-form").addEventListener("submit", handleCommentSubmit);

  function voteComment(commentId, voteType) {
    const endpoint = voteType === "up" ? `/blog/comments/${commentId}/upvote/` : `/blog/comments/${commentId}/downvote/`;
    fetch(endpoint, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/json"
      }
    })
      .then(res => res.json())
      .then(data => {
        if (data.votes !== undefined) {
          document.getElementById(`comment-votes-${commentId}`).textContent = data.votes;
        }
        loadComments(); // refresca los colores segÃºn voto
      });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  loadComments();
</script>
